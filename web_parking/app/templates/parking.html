
{% extends "base.html" %}
{% block title %}Registrar Aparcament{% endblock %}

{% block content %}

<!--<div class="wrapper">-->
<div class="section" style="z-index: 2; position: relative;padding-top: 0px !important;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card" data-color="white">
                    <div class="card-body">
                        <form id="plate-form" method="POST" action="/extract-plate" enctype="multipart/form-data">
                            <div class="form-group">
                                <div class="col-12 btn-disabled btn-neutral btn-round2">Entrar al Sistema</div>
                            </div>
                            <div class="form-group text-center">
                                <video id="video" autoplay playsinline class="rounded" style="width: 100%; max-height: 300px; border: 2px #94b9ff solid;"></video>
                                <canvas id="canvas" style="display:none;"></canvas>
                                <img id="photo" class="mt-3" src="" alt="Foto capturada" style="display:none; width: 100%; border-radius: 12px;" />
                            </div>
                            <button type="button" class="btn col-12 btn-neutral btn-round" onclick="startCamera()">Activar CÃ mera</button>
                            <div class="mt-2 form-group text-center">
                                <button type="button" class="btn btn-warning btn-sm" onclick="takePhoto()">Capturar</button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deletePhoto()">Eliminar Captura</button>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control input-class" id="plate" name="plate" placeholder="Matricula" required>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control input-class" id="model" name="model" placeholder="Model" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-neutral btn-round btn-block">Iniciar Aparcament</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
let stream; // Per guardar el MediaStream globalment

function startCamera() {
  const video = document.getElementById('video');
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: { exact: "environment" } }
  })
  .then(mediaStream => {
    stream = mediaStream;
    video.srcObject = mediaStream;
  })
  .catch(error => {
    console.error("No sâ€™ha pogut accedir a la cÃ mera del darrere:", error);
    // Si falla, fem servir la cÃ mera per defecte
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(mediaStream => {
        stream = mediaStream;
        video.srcObject = mediaStream;
      });
  });
}

function deletePhoto() {
  const photo = document.getElementById('photo');
  const video = document.getElementById('video');
  const hiddenInput = document.getElementById('imageInput');

  // Esborrem la foto i tornem a mostrar el vÃ­deo
  photo.src = '';
  photo.style.display = 'none';
  video.style.display = 'block';

  // Eliminem el valor del camp hidden (si existeix)
  if (hiddenInput) {
    hiddenInput.value = '';
  }

  // Reengeguem la cÃ mera si sâ€™ha apagat abans
  if (!video.srcObject) {
    startCamera();
  }
}
async function takePhoto() {
    const video = document.getElementById("video");
    const canvas = document.createElement("canvas");
    const photo = document.getElementById('photo');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL("image/png");

    // ðŸ‘‰ Mostra la imatge de seguida
    photo.src = imageData;
    photo.style.display = 'block';
    video.style.display = 'none';

    // ðŸ‘‰ Atura la cÃ mera immediatament
    if (stream) stream.getTracks().forEach(track => track.stop());

    // ðŸ‘‰ Envia la imatge al backend
    const formData = new FormData();
    formData.append("capturedImage", imageData);

    try {
        const response = await fetch("/extract-plate", {
            method: "POST",
            body: formData
        });

        const result = await response.json();
        if (result.plate) {
            document.getElementById("plate").value = result.plate;
        } else {
            alert("No s'ha pogut detectar cap matrÃ­cula.");
        }
    } catch (error) {
        console.error("Error en enviar la imatge:", error);
    }
}


</script>

{% endblock %}